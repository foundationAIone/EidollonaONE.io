<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Test - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a2e;
            color: white;
        }
        .test-card {
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        button {
            background: #0f3460;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #16213e;
        }
        #avatar-canvas {
            width: 100%;
            height: 400px;
            border: 2px solid #0f3460;
            background: #000;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #2a2a3e;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>üß™ Avatar Loading Test</h1>
    
    <div class="test-card">
        <h3>Debug Status</h3>
        <div id="debug-status" class="status">Starting tests...</div>
    </div>
    
    <div class="test-card">
        <h3>Avatar Canvas</h3>
        <canvas id="avatar-canvas"></canvas>
        <div>
            <button onclick="testBasics()">Test 1: Basic Setup</button>
            <button onclick="testThreeJS()">Test 2: Three.js</button>
            <button onclick="testGLB()">Test 3: GLB Loading</button>
            <button onclick="loadFullAvatar()">Test 4: Full Avatar</button>
        </div>
    </div>

    <!-- Three.js Scripts - Local first, then CDN fallbacks -->
    <script src="/webview/static/webview/js/three.min.js" 
            onload="loadGLTFLoader()" 
            onerror="loadThreeJSFallback()"></script>
    <script>
        function loadThreeJSFallback() {
            console.log('Local Three.js failed, trying CDN fallback...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/three@0.158.0/build/three.min.js';
            script.onerror = function() {
                console.log('Primary CDN failed, trying skypack...');
                const script2 = document.createElement('script');
                script2.src = 'https://cdn.skypack.dev/three@0.158.0';
                script2.onload = loadGLTFLoader;
                document.head.appendChild(script2);
            };
            script.onload = loadGLTFLoader;
            document.head.appendChild(script);
        }
        
        function loadGLTFLoader() {
            if (typeof THREE !== 'undefined') {
                console.log('Three.js loaded successfully, loading GLTFLoader...');
                const script = document.createElement('script');
                script.src = '/webview/static/webview/js/GLTFLoader.js';
                script.onerror = function() {
                    console.log('Local GLTFLoader failed, trying CDN...');
                    const script2 = document.createElement('script');
                    script2.src = 'https://unpkg.com/three@0.158.0/examples/js/loaders/GLTFLoader.js';
                    document.head.appendChild(script2);
                };
                document.head.appendChild(script);
            }
        }
        
        // Load GLTFLoader after Three.js loads
        window.addEventListener('load', function() {
            if (typeof THREE !== 'undefined') {
                loadGLTFLoader();
            }
        });
    </script>

    <script>
        function log(message) {
            const status = document.getElementById('debug-status');
            status.innerHTML += '<br>üìç ' + message;
            console.log(message);
        }

        function testBasics() {
            log('Test 1: Checking basic setup...');
            const canvas = document.getElementById('avatar-canvas');
            if (canvas) {
                log('‚úÖ Canvas found');
                canvas.style.background = '#006600';
                setTimeout(() => {
                    canvas.style.background = '#000';
                    log('‚úÖ Canvas manipulation works');
                }, 1000);
            } else {
                log('‚ùå Canvas not found');
            }
        }

        function testThreeJS() {
            log('Test 2: Checking Three.js...');
            if (typeof THREE !== 'undefined') {
                log('‚úÖ Three.js loaded');
                try {
                    const scene = new THREE.Scene();
                    const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                    const canvas = document.getElementById('avatar-canvas');
                    const renderer = new THREE.WebGLRenderer({ canvas: canvas });
                    
                    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                    log('‚úÖ Three.js scene created');
                    
                    // Simple cube test
                    const geometry = new THREE.BoxGeometry();
                    const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
                    const cube = new THREE.Mesh(geometry, material);
                    scene.add(cube);
                    camera.position.z = 5;
                    
                    function animate() {
                        requestAnimationFrame(animate);
                        cube.rotation.x += 0.01;
                        cube.rotation.y += 0.01;
                        renderer.render(scene, camera);
                    }
                    animate();
                    log('‚úÖ Green cube should be spinning');
                } catch (error) {
                    log('‚ùå Three.js error: ' + error.message);
                }
            } else {
                log('‚ùå Three.js not loaded');
            }
        }

        function testGLB() {
            log('Test 3: Testing GLB access...');
            fetch('/webview/assets/models/eidollona.glb')
                .then(response => {
                    if (response.ok) {
                        log('‚úÖ GLB file accessible');
                        log('üìä GLB size: ' + response.headers.get('content-length') + ' bytes');
                    } else {
                        log('‚ùå GLB not accessible: ' + response.status);
                    }
                })
                .catch(error => {
                    log('‚ùå GLB fetch error: ' + error.message);
                });
        }

        function loadFullAvatar() {
            log('Test 4: Loading full avatar...');
            if (typeof THREE === 'undefined' || typeof THREE.GLTFLoader === 'undefined') {
                log('‚ùå Three.js or GLTFLoader not available');
                return;
            }

            try {
                const canvas = document.getElementById('avatar-canvas');
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
                
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                renderer.setClearColor(0x1a1a2e);
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);
                
                log('üîÑ Scene setup complete, loading GLB...');
                
                const loader = new THREE.GLTFLoader();
                loader.load('/webview/assets/models/eidollona.glb', 
                    function(gltf) {
                        log('‚úÖ GLB loaded successfully!');
                        const avatar = gltf.scene;
                        avatar.scale.set(1, 1, 1);
                        avatar.position.set(0, -1, 0);
                        scene.add(avatar);
                        
                        camera.position.set(0, 0, 3);
                        
                        function animate() {
                            requestAnimationFrame(animate);
                            avatar.rotation.y += 0.005;
                            renderer.render(scene, camera);
                        }
                        animate();
                        
                        log('üé≠ Avatar should be visible and rotating!');
                    },
                    function(progress) {
                        log('üì• Loading progress: ' + Math.round((progress.loaded / progress.total) * 100) + '%');
                    },
                    function(error) {
                        log('‚ùå GLB loading error: ' + error.message);
                        console.error('Full error:', error);
                    }
                );
            } catch (error) {
                log('‚ùå Avatar loading error: ' + error.message);
            }
        }

        // Auto-start basic test
        window.addEventListener('load', function() {
            log('üöÄ Page loaded, ready for testing');
        });
    </script>
</body>
</html>